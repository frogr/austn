<% meta_title("Text to Speech") %>
<% meta_description("Free text-to-speech and voice cloning online. Generate realistic speech with Chatterbox TTS running on local GPU. No sign-up, no API fees.") %>

<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
  <!-- Header -->
  <div id="tts-header" style="display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
    <div style="text-align: center;">
      <h1 class="font-black mb-2" style="font-size: clamp(2rem, 5vw, 3.5rem); color: var(--text-primary); letter-spacing: -0.03em;">
        Text to Speech <%= render "shared/gpu_health_indicator", service: "tts" %>
      </h1>
    </div>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <a href="<%= new_tts_path %>" class="inline-flex items-center gap-2 font-semibold py-2.5 px-5 rounded-md transition duration-200 text-white" style="background: linear-gradient(45deg, #10b981, #059669); flex-shrink: 0;">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
        New
      </a>
      <a href="<%= admin_root_path %>" data-turbo="false" class="p-2.5 rounded-md transition-colors hover:bg-white/10 text-gray-500 hover:text-gray-300" title="Admin">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </a>
    </div>
  </div>

  <!-- Shares Table (Desktop) / Cards (Mobile) -->
  <div class="rounded-lg overflow-hidden" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);">
    <% if @shares.any? %>
      <!-- Desktop Table View -->
      <div id="tts-desktop-table" style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(255,255,255,0.05);">
              <th style="text-align: left; padding: 0.75rem 1rem; font-size: 0.875rem; font-weight: 600; color: #d1d5db;">Created</th>
              <th style="text-align: left; padding: 0.75rem 1rem; font-size: 0.875rem; font-weight: 600; color: #d1d5db;">Voice</th>
              <th style="text-align: left; padding: 0.75rem 1rem; font-size: 0.875rem; font-weight: 600; color: #d1d5db;">Transcript</th>
              <th style="text-align: left; padding: 0.75rem 1rem; font-size: 0.875rem; font-weight: 600; color: #d1d5db;">Duration</th>
              <th style="text-align: center; padding: 0.75rem 1rem; font-size: 0.875rem; font-weight: 600; color: #d1d5db;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @shares.each do |share| %>
              <tr style="border-top: 1px solid rgba(255,255,255,0.05);" data-share-token="<%= share.token %>">
                <td style="padding: 0.75rem 1rem; font-size: 0.875rem; color: #9ca3af; white-space: nowrap;">
                  <%= share.created_at.strftime("%b %d, %Y") %>
                  <span style="color: #6b7280; font-size: 0.75rem; display: block;"><%= share.created_at.strftime("%l:%M %p") %></span>
                </td>
                <td style="padding: 0.75rem 1rem; font-size: 0.875rem; color: #9ca3af; white-space: nowrap;">
                  <%= voice_name_for(share.voice_preset, @voices) %>
                </td>
                <td style="padding: 0.75rem 1rem; font-size: 0.875rem; color: #fff; max-width: 20rem;">
                  <span style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;" title="<%= share.text %>"><%= truncate(share.text, length: 80) %></span>
                </td>
                <td style="padding: 0.75rem 1rem; font-size: 0.875rem; color: #9ca3af; white-space: nowrap;">
                  <%= share.duration ? "#{share.duration.round(1)}s" : "-" %>
                </td>
                <td style="padding: 0.75rem 1rem;">
                  <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <button onclick="playAudio('<%= share.token %>')" style="padding: 0.5rem; border-radius: 0.375rem; background: transparent; border: none; cursor: pointer;" title="Play audio" data-play-btn="<%= share.token %>">
                      <svg xmlns="http://www.w3.org/2000/svg" style="height: 1.25rem; width: 1.25rem; color: #4ade80;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </button>
                    <a href="<%= tts_share_audio_path(share.token) %>" download="tts-<%= share.token %>.wav" style="padding: 0.5rem; border-radius: 0.375rem; display: inline-block;" title="Download audio">
                      <svg xmlns="http://www.w3.org/2000/svg" style="height: 1.25rem; width: 1.25rem; color: #60a5fa;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                      </svg>
                    </a>
                    <button onclick="copyShareLink('<%= tts_share_url(share.token) %>', this)" style="padding: 0.5rem; border-radius: 0.375rem; background: transparent; border: none; cursor: pointer;" title="Copy share link">
                      <svg xmlns="http://www.w3.org/2000/svg" style="height: 1.25rem; width: 1.25rem; color: #c084fc;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Mobile Card View -->
      <div id="tts-mobile-cards">
        <% @shares.each do |share| %>
          <div style="padding: 1rem; border-top: 1px solid rgba(255,255,255,0.05);" data-share-token="<%= share.token %>">
            <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.5rem;">
              <div style="flex: 1; min-width: 0;">
                <p style="font-size: 0.875rem; color: #fff; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin: 0 0 0.25rem 0;"><%= truncate(share.text, length: 100) %></p>
                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                  <span><%= voice_name_for(share.voice_preset, @voices) %></span>
                  <span>â€¢</span>
                  <span><%= share.duration ? "#{share.duration.round(1)}s" : "-" %></span>
                </div>
              </div>
              <span style="font-size: 0.75rem; color: #6b7280; white-space: nowrap;"><%= share.created_at.strftime("%b %d") %></span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.25rem; margin-top: 0.75rem;">
              <button onclick="playAudio('<%= share.token %>')" style="display: flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; background: rgba(34, 197, 94, 0.2); color: #4ade80; border: none; cursor: pointer;" data-play-btn="<%= share.token %>">
                <svg xmlns="http://www.w3.org/2000/svg" style="height: 1rem; width: 1rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Play
              </button>
              <a href="<%= tts_share_audio_path(share.token) %>" download="tts-<%= share.token %>.wav" style="padding: 0.5rem; border-radius: 0.375rem; display: inline-block;" title="Download">
                <svg xmlns="http://www.w3.org/2000/svg" style="height: 1.25rem; width: 1.25rem; color: #60a5fa;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
              </a>
              <button onclick="copyShareLink('<%= tts_share_url(share.token) %>', this)" style="padding: 0.5rem; border-radius: 0.375rem; background: transparent; border: none; cursor: pointer;" title="Copy link">
                <svg xmlns="http://www.w3.org/2000/svg" style="height: 1.25rem; width: 1.25rem; color: #c084fc;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
              </button>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div style="text-align: center; padding: 3rem 1rem;">
        <svg xmlns="http://www.w3.org/2000/svg" style="height: 4rem; width: 4rem; margin: 0 auto 1rem; color: #4b5563;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
        </svg>
        <h3 style="font-size: 1.125rem; font-weight: 600; color: #d1d5db; margin: 0 0 0.5rem 0;">No shared audio yet</h3>
        <p style="color: #6b7280; margin: 0 0 1.5rem 0;">Generate some text-to-speech and share it!</p>
        <a href="<%= new_tts_path %>" style="display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 600; padding: 0.625rem 1.25rem; border-radius: 0.375rem; color: #fff; text-decoration: none; background: linear-gradient(45deg, #10b981, #059669);">
          <svg xmlns="http://www.w3.org/2000/svg" style="height: 1.25rem; width: 1.25rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
          </svg>
          Create Your First
        </a>
      </div>
    <% end %>
  </div>

  <!-- Hidden audio player for playing clips -->
  <audio id="global-audio-player" style="display: none;"></audio>
</div>

<style>
  /* Responsive header */
  @media (min-width: 640px) {
    #tts-header {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
    #tts-header > div:first-child {
      text-align: left;
    }
  }

  /* Desktop/Mobile toggle */
  #tts-mobile-cards {
    display: block;
  }
  #tts-desktop-table {
    display: none;
  }

  @media (min-width: 768px) {
    #tts-mobile-cards {
      display: none;
    }
    #tts-desktop-table {
      display: block;
    }
  }

  /* Remove first card border */
  #tts-mobile-cards > div:first-child {
    border-top: none;
  }
</style>

<script>
(function() {
  if (window.ttsIndexInitialized) return;
  window.ttsIndexInitialized = true;

  window.ttsCurrentlyPlayingToken = null;

  window.playAudio = function(token) {
    const audioPlayer = document.getElementById('global-audio-player');
    const playBtns = document.querySelectorAll(`[data-play-btn="${token}"]`);

    if (window.ttsCurrentlyPlayingToken === token && !audioPlayer.paused) {
      audioPlayer.pause();
      window.resetPlayButton(token);
      window.ttsCurrentlyPlayingToken = null;
      return;
    }

    if (window.ttsCurrentlyPlayingToken) {
      window.resetPlayButton(window.ttsCurrentlyPlayingToken);
    }

    audioPlayer.src = `/tts/s/${token}/audio`;
    audioPlayer.play();
    window.ttsCurrentlyPlayingToken = token;

    playBtns.forEach(btn => {
      btn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" style="height: 1.25rem; width: 1.25rem; color: #4ade80;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      `;
    });
  };

  window.resetPlayButton = function(token) {
    const playBtns = document.querySelectorAll(`[data-play-btn="${token}"]`);
    playBtns.forEach(btn => {
      const isMobile = btn.textContent.includes('Play');
      if (isMobile) {
        btn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" style="height: 1rem; width: 1rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Play
        `;
      } else {
        btn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" style="height: 1.25rem; width: 1.25rem; color: #4ade80;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        `;
      }
    });
  };

  window.copyShareLink = async function(url, button) {
    try {
      await navigator.clipboard.writeText(url);
      const originalSvg = button.innerHTML;
      button.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" style="height: 1.25rem; width: 1.25rem; color: #4ade80;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
      `;
      setTimeout(() => {
        button.innerHTML = originalSvg;
      }, 1500);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  };

  const audioPlayer = document.getElementById('global-audio-player');
  if (audioPlayer) {
    audioPlayer.addEventListener('ended', () => {
      if (window.ttsCurrentlyPlayingToken) {
        window.resetPlayButton(window.ttsCurrentlyPlayingToken);
        window.ttsCurrentlyPlayingToken = null;
      }
    });
  }
})();
</script>
