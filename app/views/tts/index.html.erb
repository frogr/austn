<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 md:mb-8 gap-4">
    <div>
      <h1 class="font-black mb-2" style="font-size: clamp(2.5rem, 5vw, 3.5rem); color: var(--text-primary); letter-spacing: -0.03em;">
        Text to Speech <%= render "shared/gpu_health_indicator", service: "tts" %>
      </h1>
    </div>
    <div class="flex items-center gap-2">
      <a href="<%= new_tts_path %>" class="inline-flex items-center gap-2 font-semibold py-2.5 px-5 rounded-md transition duration-200 text-white shrink-0" style="background: linear-gradient(45deg, #10b981, #059669);">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
        New
      </a>
      <a href="<%= admin_root_path %>" data-turbo="false" class="p-2.5 rounded-md transition-colors hover:bg-white/10 text-gray-500 hover:text-gray-300" title="Admin">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </a>
    </div>
  </div>

  <!-- Shares Table (Desktop) / Cards (Mobile) -->
  <div class="rounded-lg overflow-hidden" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);">
    <% if @shares.any? %>
      <!-- Desktop Table View -->
      <div class="hidden md:block overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr style="background: rgba(255,255,255,0.05);">
              <th class="text-left px-4 py-3 text-sm font-semibold text-gray-300">Created</th>
              <th class="text-left px-4 py-3 text-sm font-semibold text-gray-300">Voice</th>
              <th class="text-left px-4 py-3 text-sm font-semibold text-gray-300">Transcript</th>
              <th class="text-left px-4 py-3 text-sm font-semibold text-gray-300">Duration</th>
              <th class="text-center px-4 py-3 text-sm font-semibold text-gray-300">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y" style="border-color: rgba(255,255,255,0.05);">
            <% @shares.each do |share| %>
              <tr class="hover:bg-white/5 transition-colors" data-share-token="<%= share.token %>">
                <td class="px-4 py-3 text-sm text-gray-400 whitespace-nowrap">
                  <%= share.created_at.strftime("%b %d, %Y") %>
                  <span class="text-gray-500 text-xs block"><%= share.created_at.strftime("%l:%M %p") %></span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-400 whitespace-nowrap">
                  <%= voice_name_for(share.voice_preset, @voices) %>
                </td>
                <td class="px-4 py-3 text-sm text-white max-w-xs">
                  <span class="line-clamp-2" title="<%= share.text %>"><%= truncate(share.text, length: 80) %></span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-400 whitespace-nowrap">
                  <%= share.duration ? "#{share.duration.round(1)}s" : "-" %>
                </td>
                <td class="px-4 py-3">
                  <div class="flex items-center justify-center gap-2">
                    <!-- Play Button -->
                    <button
                      onclick="playAudio('<%= share.token %>')"
                      class="p-2 rounded-md transition-colors hover:bg-white/10"
                      title="Play audio"
                      data-play-btn="<%= share.token %>"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </button>

                    <!-- Download Button -->
                    <a
                      href="<%= tts_share_audio_path(share.token) %>"
                      download="tts-<%= share.token %>.wav"
                      class="p-2 rounded-md transition-colors hover:bg-white/10"
                      title="Download audio"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                      </svg>
                    </a>

                    <!-- Copy Link Button -->
                    <button
                      onclick="copyShareLink('<%= tts_share_url(share.token) %>', this)"
                      class="p-2 rounded-md transition-colors hover:bg-white/10"
                      title="Copy share link"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Mobile Card View -->
      <div class="md:hidden divide-y" style="border-color: rgba(255,255,255,0.05);">
        <% @shares.each do |share| %>
          <div class="p-4" data-share-token="<%= share.token %>">
            <div class="flex items-start justify-between gap-3 mb-2">
              <div class="flex-1 min-w-0">
                <p class="text-sm text-white line-clamp-2 mb-1"><%= truncate(share.text, length: 100) %></p>
                <div class="flex items-center gap-2 text-xs text-gray-500">
                  <span><%= voice_name_for(share.voice_preset, @voices) %></span>
                  <span>â€¢</span>
                  <span><%= share.duration ? "#{share.duration.round(1)}s" : "-" %></span>
                </div>
              </div>
              <span class="text-xs text-gray-500 whitespace-nowrap"><%= share.created_at.strftime("%b %d") %></span>
            </div>
            <div class="flex items-center gap-1 mt-3">
              <button
                onclick="playAudio('<%= share.token %>')"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-green-500/20 text-green-400 hover:bg-green-500/30"
                data-play-btn="<%= share.token %>"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Play
              </button>
              <a
                href="<%= tts_share_audio_path(share.token) %>"
                download="tts-<%= share.token %>.wav"
                class="p-2 rounded-md transition-colors hover:bg-white/10"
                title="Download"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
              </a>
              <button
                onclick="copyShareLink('<%= tts_share_url(share.token) %>', this)"
                class="p-2 rounded-md transition-colors hover:bg-white/10"
                title="Copy link"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
              </button>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-12 px-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
        </svg>
        <h3 class="text-lg font-semibold text-gray-300 mb-2">No shared audio yet</h3>
        <p class="text-gray-500 mb-6">Generate some text-to-speech and share it!</p>
        <a href="<%= new_tts_path %>" class="inline-flex items-center gap-2 font-semibold py-2.5 px-5 rounded-md transition duration-200 text-white" style="background: linear-gradient(45deg, #10b981, #059669);">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
          </svg>
          Create Your First
        </a>
      </div>
    <% end %>
  </div>

  <!-- Hidden audio player for playing clips -->
  <audio id="global-audio-player" style="display: none;"></audio>
</div>

<script>
let currentlyPlayingToken = null;
const audioPlayer = document.getElementById('global-audio-player');

function playAudio(token) {
  const playBtn = document.querySelector(`[data-play-btn="${token}"]`);

  // If clicking the same one that's playing, pause it
  if (currentlyPlayingToken === token && !audioPlayer.paused) {
    audioPlayer.pause();
    resetPlayButton(token);
    currentlyPlayingToken = null;
    return;
  }

  // Stop any currently playing audio
  if (currentlyPlayingToken) {
    resetPlayButton(currentlyPlayingToken);
  }

  // Play new audio
  audioPlayer.src = `/tts/s/${token}/audio`;
  audioPlayer.play();
  currentlyPlayingToken = token;

  // Update button to show pause state
  if (playBtn) {
    playBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    `;
  }
}

function resetPlayButton(token) {
  const playBtn = document.querySelector(`[data-play-btn="${token}"]`);
  if (playBtn) {
    playBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    `;
  }
}

// Reset button when audio ends
audioPlayer.addEventListener('ended', () => {
  if (currentlyPlayingToken) {
    resetPlayButton(currentlyPlayingToken);
    currentlyPlayingToken = null;
  }
});

async function copyShareLink(url, button) {
  try {
    await navigator.clipboard.writeText(url);
    // Visual feedback
    const originalSvg = button.innerHTML;
    button.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
      </svg>
    `;
    setTimeout(() => {
      button.innerHTML = originalSvg;
    }, 1500);
  } catch (err) {
    console.error('Failed to copy:', err);
  }
}
</script>
