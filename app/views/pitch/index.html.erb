<% content_for(:title) { "Pitch Checker - austn.net" } %>
<% content_for(:meta_description) { "Real-time pitch detection tool. Tune your guitar, check your singing — see what note you're playing on a visual piano roll with cents accuracy." } %>

<div class="pitch-page" data-controller="pitch-detector">

  <%# Header %>
  <div class="pitch-header">
    <h1 class="pitch-title">Pitch Checker</h1>
    <p class="pitch-subtitle">Real-time pitch detection for voice &amp; guitar</p>
  </div>

  <%# Start button (shown before mic permission) %>
  <div class="pitch-start-container" data-pitch-detector-target="startBtn">
    <button class="pitch-start-btn btn-primary" data-action="click->pitch-detector#start">
      <span class="material-icons">mic</span>
      Enable Microphone
    </button>
    <p class="pitch-start-hint">Microphone audio stays on your device — nothing is sent to any server.</p>
  </div>

  <%# Status %>
  <div class="pitch-status" data-pitch-detector-target="status"></div>

  <%# Main display card %>
  <div class="pitch-main-card glass">

    <%# Top row: Note + Frequency %>
    <div class="pitch-note-row">
      <div class="pitch-note-display" data-pitch-detector-target="noteDisplay">--</div>
      <div class="pitch-freq-display" data-pitch-detector-target="freqDisplay">-- Hz</div>
    </div>

    <%# Cents gauge %>
    <div class="pitch-cents-section">
      <div class="pitch-cents-gauge" data-pitch-detector-target="centsGauge">
        <div class="pitch-cents-track">
          <div class="pitch-cents-marker" style="left: 0%;">-50</div>
          <div class="pitch-cents-marker" style="left: 25%;">-25</div>
          <div class="pitch-cents-marker pitch-cents-marker-center" style="left: 50%;">0</div>
          <div class="pitch-cents-marker" style="left: 75%;">+25</div>
          <div class="pitch-cents-marker" style="left: 100%;">+50</div>
          <div class="pitch-cents-zone pitch-cents-zone-green"></div>
          <div class="pitch-cents-needle" data-pitch-detector-target="centsNeedle"></div>
        </div>
      </div>
      <div class="pitch-cents-value" data-pitch-detector-target="centsValue">0c</div>
    </div>

    <%# Level meter %>
    <div class="pitch-level-section">
      <span class="material-icons pitch-level-icon">graphic_eq</span>
      <div class="pitch-level-meter" data-pitch-detector-target="levelMeter">
        <div class="pitch-level-fill" data-pitch-detector-target="levelFill"></div>
      </div>
    </div>

    <%# Guitar info (hidden in chromatic mode) %>
    <div class="pitch-guitar-info" data-pitch-detector-target="guitarInfo" style="display: none;">
      <span class="material-icons" style="color: var(--text-muted); font-size: 1.2rem;">music_note</span>
      <span class="guitar-string-badge">--</span>
      <span class="guitar-cents" style="color: var(--text-muted);">--</span>
    </div>
  </div>

  <%# Piano roll + history overlay %>
  <div class="pitch-piano-section glass">
    <div class="pitch-piano-header">
      <span class="pitch-piano-label">Piano Roll</span>
      <span class="pitch-piano-hint">Click a key to play reference tone</span>
    </div>
    <div class="pitch-piano-viewport">
      <canvas class="pitch-history-canvas" data-pitch-detector-target="historyCanvas"></canvas>
      <div class="pitch-piano-roll" data-pitch-detector-target="pianoRoll">
        <%# Keys are built dynamically by the Stimulus controller %>
      </div>
    </div>
  </div>

  <%# Controls row %>
  <div class="pitch-controls glass">
    <%# Mode toggle %>
    <div class="pitch-control-group">
      <label class="pitch-control-label">Mode</label>
      <button class="pitch-mode-toggle" data-pitch-detector-target="modeToggle"
              data-action="click->pitch-detector#toggleMode" role="switch" aria-checked="false">
        <span class="pitch-mode-option pitch-mode-active">Chromatic</span>
        <span class="pitch-mode-option">Guitar</span>
        <span class="pitch-mode-slider"></span>
      </button>
      <span class="pitch-mode-label" data-pitch-detector-target="modeLabel">Chromatic</span>
    </div>

    <%# Noise gate %>
    <div class="pitch-control-group">
      <label class="pitch-control-label">
        Noise Gate
        <span class="pitch-noise-gate-val" data-pitch-detector-target="noiseGateValue">1</span>
      </label>
      <input type="range" class="pitch-noise-slider" min="0.002" max="0.1" step="0.002" value="0.01"
             data-pitch-detector-target="noiseGate"
             data-action="input->pitch-detector#updateNoiseGate">
    </div>

    <%# Guitar reference tones (visible in guitar mode) %>
    <div class="pitch-guitar-refs" data-pitch-detector-target="guitarRefs">
      <label class="pitch-control-label">Reference Tones</label>
      <div class="pitch-guitar-btns">
        <% [['E2', 82.41], ['A2', 110.0], ['D3', 146.83], ['G3', 196.0], ['B3', 246.94], ['E4', 329.63]].each do |name, freq| %>
          <button class="pitch-guitar-ref-btn btn-secondary"
                  data-freq="<%= freq %>"
                  data-action="click->pitch-detector#playGuitarString">
            <%= name %>
          </button>
        <% end %>
      </div>
    </div>
  </div>

</div>

<style>
  /* ===== Pitch Checker Page Styles ===== */
  .pitch-page {
    max-width: 720px;
    margin: 0 auto;
    padding: 0.5rem 1rem 3rem;
  }

  .pitch-header {
    text-align: center;
    margin-bottom: 1.5rem;
  }
  .pitch-title {
    font-size: clamp(1.5rem, 4vw, 2.2rem);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 0.25rem;
    letter-spacing: -0.02em;
  }
  .pitch-subtitle {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin: 0;
  }

  /* Start button */
  .pitch-start-container {
    text-align: center;
    margin-bottom: 1.5rem;
  }
  .pitch-start-btn {
    font-size: 1.1rem;
    padding: 0.9rem 2rem;
    border-radius: 0.75rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    border: none;
    font-weight: 600;
    background: var(--gradient-accent);
    color: #fff;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  .pitch-start-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-glow);
  }
  .pitch-start-btn .material-icons { font-size: 1.4rem; }
  .pitch-start-hint {
    margin-top: 0.75rem;
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .pitch-status {
    text-align: center;
    font-size: 0.85rem;
    margin-bottom: 1rem;
    min-height: 1.2em;
  }

  /* Main display card */
  .pitch-main-card {
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
  }

  .pitch-note-row {
    text-align: center;
    margin-bottom: 1rem;
  }
  .pitch-note-display {
    font-size: clamp(3rem, 10vw, 5rem);
    font-weight: 900;
    letter-spacing: -0.03em;
    line-height: 1;
    color: var(--text-muted);
    transition: color 0.1s ease;
    font-variant-numeric: tabular-nums;
  }
  .pitch-freq-display {
    font-size: 1rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
    font-variant-numeric: tabular-nums;
  }

  /* Cents gauge */
  .pitch-cents-section {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  .pitch-cents-gauge {
    flex: 1;
  }
  .pitch-cents-track {
    position: relative;
    height: 32px;
    background: rgba(255,255,255,0.04);
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.08);
    overflow: visible;
  }
  .pitch-cents-marker {
    position: absolute;
    top: -16px;
    transform: translateX(-50%);
    font-size: 0.6rem;
    color: var(--text-muted);
    pointer-events: none;
    user-select: none;
  }
  .pitch-cents-marker-center {
    color: var(--accent-color);
    font-weight: 700;
  }
  .pitch-cents-zone-green {
    position: absolute;
    left: 45%;
    right: 45%;
    top: 0;
    bottom: 0;
    background: rgba(29, 185, 84, 0.1);
    border-radius: 6px;
  }
  .pitch-cents-needle {
    position: absolute;
    top: 2px;
    bottom: 2px;
    width: 4px;
    left: 50%;
    transform: translateX(-50%);
    border-radius: 2px;
    background: var(--accent-color);
    box-shadow: 0 0 8px var(--accent-color);
    transition: left 0.06s ease-out;
  }
  .pitch-cents-value {
    font-size: 0.9rem;
    font-weight: 600;
    min-width: 3.5rem;
    text-align: right;
    font-variant-numeric: tabular-nums;
    color: var(--text-muted);
  }

  /* Level meter */
  .pitch-level-section {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }
  .pitch-level-icon {
    font-size: 1.1rem;
    color: var(--text-muted);
  }
  .pitch-level-meter {
    flex: 1;
    height: 6px;
    background: rgba(255,255,255,0.06);
    border-radius: 3px;
    overflow: hidden;
  }
  .pitch-level-fill {
    height: 100%;
    width: 0%;
    background: var(--text-muted);
    border-radius: 3px;
    transition: width 0.05s linear;
  }

  /* Guitar info */
  .pitch-guitar-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
  }
  .guitar-string-badge {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-primary);
    padding: 0.15rem 0.5rem;
    border: 2px solid var(--text-muted);
    border-radius: 0.4rem;
    transition: border-color 0.1s ease;
  }
  .guitar-cents {
    font-size: 0.85rem;
    font-variant-numeric: tabular-nums;
  }

  /* Piano roll section */
  .pitch-piano-section {
    border-radius: 1rem;
    padding: 1rem;
    margin-bottom: 1rem;
    overflow: hidden;
  }
  .pitch-piano-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  .pitch-piano-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .pitch-piano-hint {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.35);
  }

  .pitch-piano-viewport {
    position: relative;
    height: 140px;
    overflow: hidden;
    border-radius: 0.5rem;
  }

  .pitch-history-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
    pointer-events: none;
  }

  .pitch-piano-roll {
    display: flex;
    position: relative;
    height: 100%;
    transition: transform 0.1s ease-out;
  }

  /* Piano keys */
  .piano-key {
    position: relative;
    flex-shrink: 0;
    border: none;
    cursor: pointer;
    transition: background 0.08s ease, box-shadow 0.08s ease;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 6px;
  }
  .piano-key:focus { outline: none; }

  .piano-key-white {
    width: 36px;
    height: 100%;
    background: linear-gradient(180deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.06) 100%);
    border-right: 1px solid rgba(255,255,255,0.06);
    border-radius: 0 0 4px 4px;
    z-index: 1;
  }
  .piano-key-white:hover {
    background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
  }

  .piano-key-black {
    width: 22px;
    height: 60%;
    background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.5) 100%);
    border: 1px solid rgba(255,255,255,0.08);
    border-top: none;
    border-radius: 0 0 3px 3px;
    margin-left: -11px;
    margin-right: -11px;
    z-index: 3;
  }
  .piano-key-black:hover {
    background: linear-gradient(180deg, rgba(40,40,40,0.9) 0%, rgba(30,30,30,0.7) 100%);
  }

  .piano-key-label {
    font-size: 0.5rem;
    color: rgba(255,255,255,0.3);
    pointer-events: none;
    user-select: none;
  }

  /* Active note highlight */
  .piano-key.pitch-active {
    background: var(--highlight-color, var(--accent-color)) !important;
    box-shadow: 0 0 16px var(--highlight-color, var(--accent-color)),
                inset 0 0 8px rgba(255,255,255,0.15);
  }
  .piano-key.pitch-active .piano-key-label {
    color: rgba(255,255,255,0.9);
    font-weight: 700;
  }

  /* Guitar string note markers */
  .piano-key.guitar-string-note::after {
    content: '';
    position: absolute;
    bottom: 3px;
    left: 50%;
    transform: translateX(-50%);
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--accent-color);
    opacity: 0.7;
    z-index: 4;
  }

  /* Controls */
  .pitch-controls {
    border-radius: 1rem;
    padding: 1rem 1.25rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem 1.5rem;
    align-items: flex-start;
  }
  .pitch-control-group {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }
  .pitch-control-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .pitch-noise-gate-val {
    font-variant-numeric: tabular-nums;
    color: var(--text-primary);
  }

  /* Mode toggle */
  .pitch-mode-toggle {
    position: relative;
    display: inline-flex;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 0.5rem;
    padding: 0;
    cursor: pointer;
    overflow: hidden;
  }
  .pitch-mode-option {
    padding: 0.4rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    position: relative;
    z-index: 1;
    transition: color 0.2s ease;
    user-select: none;
  }
  .pitch-mode-toggle[aria-checked="false"] .pitch-mode-option:first-child,
  .pitch-mode-toggle[aria-checked="true"] .pitch-mode-option:last-child {
    color: var(--text-primary);
  }
  .pitch-mode-slider {
    position: absolute;
    top: 2px;
    bottom: 2px;
    left: 2px;
    width: calc(50% - 2px);
    background: rgba(29, 185, 84, 0.2);
    border-radius: 0.375rem;
    transition: transform 0.2s ease;
    pointer-events: none;
  }
  .pitch-mode-toggle[aria-checked="true"] .pitch-mode-slider {
    transform: translateX(100%);
  }
  .pitch-mode-label {
    display: none; /* hidden, we have the toggle */
  }

  /* Noise gate slider */
  .pitch-noise-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 120px;
    height: 4px;
    background: rgba(255,255,255,0.1);
    border-radius: 2px;
    outline: none;
  }
  .pitch-noise-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent-color);
    cursor: pointer;
    border: 2px solid rgba(0,0,0,0.3);
  }
  .pitch-noise-slider::-moz-range-thumb {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent-color);
    cursor: pointer;
    border: 2px solid rgba(0,0,0,0.3);
  }

  /* Guitar reference buttons */
  .pitch-guitar-refs {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }
  .pitch-guitar-btns {
    display: flex;
    gap: 0.35rem;
    flex-wrap: wrap;
  }
  .pitch-guitar-ref-btn {
    font-size: 0.75rem;
    padding: 0.35rem 0.65rem;
    border-radius: 0.4rem;
    font-weight: 700;
    min-width: 2.5rem;
    text-align: center;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .pitch-page { padding: 0.5rem 0.75rem 2rem; }
    .pitch-main-card { padding: 1rem; }
    .pitch-note-display { font-size: 3rem; }
    .piano-key-white { width: 28px; }
    .piano-key-black { width: 18px; margin-left: -9px; margin-right: -9px; }
    .pitch-piano-viewport { height: 110px; }
    .pitch-controls { padding: 0.75rem; gap: 0.75rem; }
  }
</style>
