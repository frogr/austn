<% content_for(:title) { "Pitch Checker - austn.net" } %>
<% content_for(:meta_description) { "Real-time pitch detection tool. Sing along to reference tracks, tune your guitar — see your pitch on a scrolling piano roll with cents accuracy." } %>

<div class="pitch-page" data-controller="pitch-detector">

  <%# Header %>
  <div class="pitch-header">
    <h1 class="pitch-title">Pitch Checker</h1>
    <p class="pitch-subtitle">Real-time pitch detection for voice &amp; guitar</p>
  </div>

  <%# Start button %>
  <div class="pitch-start-container" data-pitch-detector-target="startBtn">
    <button class="pitch-start-btn" data-action="click->pitch-detector#start">
      <span class="material-icons">mic</span>
      Enable Microphone
    </button>
    <p class="pitch-start-hint">Audio stays on your device — nothing is sent to any server.</p>
  </div>

  <%# Status %>
  <div class="pitch-status" data-pitch-detector-target="status"></div>

  <%# Info bar: note + cents + level %>
  <div class="pitch-info-bar glass">
    <div class="pitch-info-note">
      <div class="pitch-note-display" data-pitch-detector-target="noteDisplay">--</div>
      <div class="pitch-freq-display" data-pitch-detector-target="freqDisplay">-- Hz</div>
    </div>

    <div class="pitch-info-cents">
      <div class="pitch-cents-track" data-pitch-detector-target="centsGauge">
        <div class="pitch-cents-labels">
          <span>-50</span><span>-25</span><span class="pitch-cents-center-label">0</span><span>+25</span><span>+50</span>
        </div>
        <div class="pitch-cents-bar">
          <div class="pitch-cents-zone-green"></div>
          <div class="pitch-cents-needle" data-pitch-detector-target="centsNeedle"></div>
        </div>
      </div>
      <div class="pitch-cents-value" data-pitch-detector-target="centsValue">0c</div>
    </div>

    <div class="pitch-info-level">
      <span class="material-icons pitch-level-icon">graphic_eq</span>
      <div class="pitch-level-meter" data-pitch-detector-target="levelMeter">
        <div class="pitch-level-fill" data-pitch-detector-target="levelFill"></div>
      </div>
    </div>

    <%# Guitar info (hidden in chromatic mode) %>
    <div class="pitch-guitar-info" data-pitch-detector-target="guitarInfo" style="display: none;">
      <span class="guitar-string-badge">--</span>
      <span class="guitar-cents">--</span>
    </div>
  </div>

  <%# Main grid: vertical piano keys + scrolling canvas %>
  <div class="pitch-grid-section glass">
    <div class="pitch-grid-header">
      <div class="pitch-grid-legend">
        <span class="pitch-legend-dot pitch-legend-live"></span> Your pitch
        <span class="pitch-legend-dot pitch-legend-ref"></span> Reference
      </div>
      <span class="pitch-grid-hint">Click piano keys for reference tones</span>
    </div>
    <div class="pitch-grid-container">
      <div class="pitch-piano-keys" data-pitch-detector-target="pianoKeys">
        <%# Built dynamically by Stimulus %>
      </div>
      <div class="pitch-canvas-wrap">
        <canvas class="pitch-grid-canvas" data-pitch-detector-target="gridCanvas"></canvas>
      </div>
    </div>
  </div>

  <%# Controls %>
  <div class="pitch-controls glass">
    <%# Mode toggle %>
    <div class="pitch-control-group">
      <label class="pitch-control-label">Mode</label>
      <button class="pitch-mode-toggle" data-pitch-detector-target="modeToggle"
              data-action="click->pitch-detector#toggleMode" role="switch" aria-checked="false">
        <span class="pitch-mode-option">Chromatic</span>
        <span class="pitch-mode-option">Guitar</span>
        <span class="pitch-mode-slider"></span>
      </button>
      <span class="pitch-mode-label" data-pitch-detector-target="modeLabel">Chromatic</span>
    </div>

    <%# Noise gate %>
    <div class="pitch-control-group">
      <label class="pitch-control-label">
        Noise Gate
        <span class="pitch-gate-val" data-pitch-detector-target="noiseGateValue">1.5</span>
      </label>
      <input type="range" class="pitch-slider" min="0.002" max="0.1" step="0.002" value="0.015"
             data-pitch-detector-target="noiseGate"
             data-action="input->pitch-detector#updateNoiseGate">
    </div>

    <%# Reference audio %>
    <div class="pitch-control-group pitch-ref-group">
      <label class="pitch-control-label">Reference Track</label>
      <input type="file" accept="audio/*" class="pitch-ref-file-input"
             data-pitch-detector-target="refFileInput"
             data-action="change->pitch-detector#handleRefFile"
             style="display: none;">
      <div class="pitch-ref-controls">
        <button class="pitch-ref-btn btn-secondary" data-action="click->pitch-detector#loadReference">
          <span class="material-icons">upload_file</span> Load Audio
        </button>
        <button class="pitch-ref-btn btn-primary" data-pitch-detector-target="refPlayBtn"
                data-action="click->pitch-detector#playRef" style="display: none;">
          <span class="material-icons">play_arrow</span> Play
        </button>
        <button class="pitch-ref-btn pitch-ref-stop-btn" data-pitch-detector-target="refStopBtn"
                data-action="click->pitch-detector#stopRef" style="display: none;">
          <span class="material-icons">stop</span> Stop
        </button>
        <button class="pitch-ref-clear-btn" data-action="click->pitch-detector#clearRef"
                data-pitch-detector-target="refClearBtn" style="display: none;" title="Remove reference">
          <span class="material-icons">close</span>
        </button>
      </div>
      <span class="pitch-ref-name" data-pitch-detector-target="refName" style="display: none;"></span>
      <span class="pitch-ref-status" data-pitch-detector-target="refStatus"></span>
    </div>

    <%# Guitar reference tones %>
    <div class="pitch-control-group">
      <label class="pitch-control-label">Reference Tones</label>
      <div class="pitch-guitar-btns">
        <% [['E2', 82.41], ['A2', 110.0], ['D3', 146.83], ['G3', 196.0], ['B3', 246.94], ['E4', 329.63]].each do |name, freq| %>
          <button class="pitch-ref-tone-btn btn-secondary"
                  data-freq="<%= freq %>"
                  data-action="click->pitch-detector#playGuitarString">
            <%= name %>
          </button>
        <% end %>
      </div>
    </div>
  </div>

</div>

<style>
  .pitch-page {
    max-width: 960px;
    margin: 0 auto;
    padding: 0.5rem 1rem 3rem;
  }

  .pitch-header { text-align: center; margin-bottom: 1.25rem; }
  .pitch-title {
    font-size: clamp(1.5rem, 4vw, 2.2rem);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 0.25rem;
    letter-spacing: -0.02em;
  }
  .pitch-subtitle { color: var(--text-muted); font-size: 0.9rem; margin: 0; }

  /* Start button */
  .pitch-start-container { text-align: center; margin-bottom: 1.25rem; }
  .pitch-start-btn {
    font-size: 1.1rem; padding: 0.9rem 2rem; border-radius: 0.75rem;
    display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer;
    border: none; font-weight: 600; background: var(--gradient-accent); color: #fff;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  .pitch-start-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-glow); }
  .pitch-start-btn .material-icons { font-size: 1.4rem; }
  .pitch-start-hint { margin-top: 0.75rem; font-size: 0.75rem; color: var(--text-muted); }

  .pitch-status { text-align: center; font-size: 0.85rem; margin-bottom: 0.75rem; min-height: 1.2em; }

  /* Info bar */
  .pitch-info-bar {
    border-radius: 1rem;
    padding: 1rem 1.25rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 1.25rem;
    flex-wrap: wrap;
  }

  .pitch-info-note { display: flex; align-items: baseline; gap: 0.5rem; }
  .pitch-note-display {
    font-size: 2.5rem; font-weight: 900; letter-spacing: -0.03em;
    line-height: 1; color: var(--text-muted); transition: color 0.1s ease;
    font-variant-numeric: tabular-nums;
  }
  .pitch-freq-display { font-size: 0.85rem; color: var(--text-muted); font-variant-numeric: tabular-nums; }

  .pitch-info-cents { flex: 1; min-width: 180px; }
  .pitch-cents-track { position: relative; }
  .pitch-cents-labels {
    display: flex; justify-content: space-between;
    font-size: 0.55rem; color: var(--text-muted); margin-bottom: 2px;
    user-select: none;
  }
  .pitch-cents-center-label { color: var(--accent-color); font-weight: 700; }
  .pitch-cents-bar {
    position: relative; height: 20px;
    background: rgba(255,255,255,0.04); border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.08);
  }
  .pitch-cents-zone-green {
    position: absolute; left: 45%; right: 45%; top: 0; bottom: 0;
    background: rgba(29, 185, 84, 0.1); border-radius: 4px;
  }
  .pitch-cents-needle {
    position: absolute; top: 2px; bottom: 2px; width: 4px; left: 50%;
    transform: translateX(-50%); border-radius: 2px;
    background: var(--accent-color); box-shadow: 0 0 8px var(--accent-color);
    transition: left 0.06s ease-out;
  }
  .pitch-cents-value {
    font-size: 0.8rem; font-weight: 600; text-align: right;
    font-variant-numeric: tabular-nums; color: var(--text-muted); margin-top: 2px;
  }

  .pitch-info-level { display: flex; align-items: center; gap: 0.4rem; min-width: 100px; }
  .pitch-level-icon { font-size: 1rem; color: var(--text-muted); }
  .pitch-level-meter {
    flex: 1; height: 6px; background: rgba(255,255,255,0.06);
    border-radius: 3px; overflow: hidden;
  }
  .pitch-level-fill {
    height: 100%; width: 0%; background: var(--text-muted);
    border-radius: 3px; transition: width 0.05s linear;
  }

  .pitch-guitar-info {
    display: flex; align-items: center; gap: 0.5rem;
    padding: 0.35rem 0.6rem; border-radius: 0.4rem;
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
  }
  .guitar-string-badge {
    font-size: 0.9rem; font-weight: 700; color: var(--text-primary);
    padding: 0.1rem 0.4rem; border: 2px solid var(--text-muted);
    border-radius: 0.3rem; transition: border-color 0.1s ease;
  }
  .guitar-cents { font-size: 0.8rem; font-variant-numeric: tabular-nums; }

  /* Grid section (the main visualization) */
  .pitch-grid-section {
    border-radius: 1rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    overflow: hidden;
  }
  .pitch-grid-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 0.5rem; padding: 0 0.25rem;
  }
  .pitch-grid-legend {
    display: flex; align-items: center; gap: 0.5rem;
    font-size: 0.7rem; color: var(--text-muted);
  }
  .pitch-legend-dot {
    width: 8px; height: 8px; border-radius: 50%; display: inline-block;
  }
  .pitch-legend-live { background: #1DB954; }
  .pitch-legend-ref { background: #BF5AF2; }
  .pitch-grid-hint { font-size: 0.65rem; color: rgba(255,255,255,0.3); }

  .pitch-grid-container {
    display: flex;
    height: 420px;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.06);
  }

  /* Vertical piano keys */
  .pitch-piano-keys {
    width: 48px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    background: rgba(0,0,0,0.3);
    border-right: 1px solid rgba(255,255,255,0.1);
    overflow: hidden;
  }

  .vkey {
    flex: 1;
    min-height: 0;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 0 4px;
    transition: background 0.08s ease;
    position: relative;
  }
  .vkey:focus { outline: none; }

  .vkey-white {
    background: rgba(255,255,255,0.06);
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .vkey-white:hover { background: rgba(255,255,255,0.12); }

  .vkey-black {
    background: rgba(0,0,0,0.5);
    border-bottom: 1px solid rgba(255,255,255,0.02);
  }
  .vkey-black:hover { background: rgba(40,40,40,0.7); }

  .vkey-label {
    font-size: 0.5rem;
    color: rgba(255,255,255,0.4);
    pointer-events: none;
    user-select: none;
    white-space: nowrap;
    line-height: 1;
  }

  /* Canvas */
  .pitch-canvas-wrap {
    flex: 1;
    position: relative;
    min-width: 0;
  }
  .pitch-grid-canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
  }

  /* Controls */
  .pitch-controls {
    border-radius: 1rem;
    padding: 1rem 1.25rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem 1.5rem;
    align-items: flex-start;
  }
  .pitch-control-group { display: flex; flex-direction: column; gap: 0.35rem; }
  .pitch-control-label {
    font-size: 0.7rem; font-weight: 600; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.05em;
    display: flex; align-items: center; gap: 0.4rem;
  }
  .pitch-gate-val { font-variant-numeric: tabular-nums; color: var(--text-primary); }

  .pitch-mode-toggle {
    position: relative; display: inline-flex;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 0.5rem; padding: 0; cursor: pointer; overflow: hidden;
  }
  .pitch-mode-option {
    padding: 0.4rem 0.75rem; font-size: 0.75rem; font-weight: 600;
    color: var(--text-muted); position: relative; z-index: 1;
    transition: color 0.2s ease; user-select: none;
  }
  .pitch-mode-toggle[aria-checked="false"] .pitch-mode-option:first-child,
  .pitch-mode-toggle[aria-checked="true"] .pitch-mode-option:last-child {
    color: var(--text-primary);
  }
  .pitch-mode-slider {
    position: absolute; top: 2px; bottom: 2px; left: 2px;
    width: calc(50% - 2px); background: rgba(29, 185, 84, 0.2);
    border-radius: 0.375rem; transition: transform 0.2s ease; pointer-events: none;
  }
  .pitch-mode-toggle[aria-checked="true"] .pitch-mode-slider {
    transform: translateX(100%);
  }
  .pitch-mode-label { display: none; }

  .pitch-slider {
    -webkit-appearance: none; appearance: none;
    width: 120px; height: 4px; background: rgba(255,255,255,0.1);
    border-radius: 2px; outline: none;
  }
  .pitch-slider::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none;
    width: 14px; height: 14px; border-radius: 50%;
    background: var(--accent-color); cursor: pointer; border: 2px solid rgba(0,0,0,0.3);
  }
  .pitch-slider::-moz-range-thumb {
    width: 14px; height: 14px; border-radius: 50%;
    background: var(--accent-color); cursor: pointer; border: 2px solid rgba(0,0,0,0.3);
  }

  /* Reference audio controls */
  .pitch-ref-group { min-width: 200px; }
  .pitch-ref-controls { display: flex; gap: 0.35rem; align-items: center; flex-wrap: wrap; }
  .pitch-ref-btn {
    font-size: 0.75rem; padding: 0.35rem 0.65rem; border-radius: 0.4rem;
    font-weight: 600; display: inline-flex; align-items: center; gap: 0.3rem;
    cursor: pointer; border: none;
  }
  .pitch-ref-btn .material-icons { font-size: 1rem; }
  .pitch-ref-stop-btn {
    font-size: 0.75rem; padding: 0.35rem 0.65rem; border-radius: 0.4rem;
    font-weight: 600; display: inline-flex; align-items: center; gap: 0.3rem;
    cursor: pointer; border: none;
    background: rgba(255, 59, 48, 0.2); color: var(--danger-color);
  }
  .pitch-ref-stop-btn:hover { background: rgba(255, 59, 48, 0.3); }
  .pitch-ref-clear-btn {
    background: none; border: none; color: var(--text-muted); cursor: pointer;
    padding: 0.2rem; border-radius: 50%; display: inline-flex; align-items: center;
  }
  .pitch-ref-clear-btn:hover { color: var(--danger-color); background: rgba(255,255,255,0.06); }
  .pitch-ref-clear-btn .material-icons { font-size: 1rem; }
  .pitch-ref-name {
    font-size: 0.7rem; color: var(--text-muted); font-style: italic;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;
  }
  .pitch-ref-status { font-size: 0.7rem; }

  /* Guitar reference tone buttons */
  .pitch-guitar-btns { display: flex; gap: 0.35rem; flex-wrap: wrap; }
  .pitch-ref-tone-btn {
    font-size: 0.75rem; padding: 0.3rem 0.55rem; border-radius: 0.4rem;
    font-weight: 700; min-width: 2.2rem; text-align: center;
    cursor: pointer; border: none;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .pitch-page { padding: 0.5rem 0.5rem 2rem; }
    .pitch-info-bar { padding: 0.75rem; gap: 0.75rem; }
    .pitch-note-display { font-size: 2rem; }
    .pitch-grid-container { height: 320px; }
    .pitch-piano-keys { width: 36px; }
    .vkey-label { font-size: 0.4rem; }
    .pitch-controls { padding: 0.75rem; gap: 0.75rem; }
    .pitch-info-cents { min-width: 140px; }
  }
</style>
