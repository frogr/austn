<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 md:mb-8 gap-4">
    <div>
      <h1 class="font-black mb-2" style="font-size: clamp(2rem, 4vw, 2.5rem); color: var(--text-primary); letter-spacing: -0.03em;">
        TTS Administration
      </h1>
      <p class="text-gray-400 text-sm">
        <%= @active_count %> active, <%= @expired_count %> expired
      </p>
    </div>
    <div class="flex gap-2">
      <%= link_to tts_path, class: "inline-flex items-center gap-2 font-semibold py-2 px-4 rounded-md transition duration-200 text-white bg-gray-700 hover:bg-gray-600" do %>
        Back to TTS
      <% end %>
      <% if @expired_count > 0 %>
        <%= button_to "Cleanup Expired", cleanup_expired_admin_tts_shares_path, method: :post, class: "inline-flex items-center gap-2 font-semibold py-2 px-4 rounded-md transition duration-200 text-white bg-orange-600 hover:bg-orange-500" %>
      <% end %>
    </div>
  </div>

  <% if notice.present? %>
    <div class="mb-4 p-3 rounded-md bg-green-900/50 text-green-300 border border-green-700">
      <%= notice %>
    </div>
  <% end %>

  <% if alert.present? %>
    <div class="mb-4 p-3 rounded-md bg-red-900/50 text-red-300 border border-red-700">
      <%= alert %>
    </div>
  <% end %>

  <div class="rounded-lg overflow-hidden" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);">
    <% if @shares.any? %>
      <!-- Bulk Actions -->
      <%= form_with url: bulk_destroy_admin_tts_shares_path, method: :post, id: "bulk-form" do %>
        <div class="p-3 flex items-center gap-4" style="background: rgba(255,255,255,0.05);">
          <label class="flex items-center gap-2 text-sm text-gray-400">
            <input type="checkbox" id="select-all" class="rounded bg-gray-700 border-gray-600">
            Select All
          </label>
          <button type="submit" onclick="return confirm('Delete selected shares?')" class="text-sm px-3 py-1 rounded bg-red-600 hover:bg-red-500 text-white transition-colors">
            Delete Selected
          </button>
        </div>
        <div id="checkbox-container"></div>
      <% end %>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr style="background: rgba(255,255,255,0.03);">
              <th class="w-10 px-4 py-3"></th>
              <th class="text-left px-4 py-3 text-sm font-semibold text-gray-300">Created</th>
              <th class="text-left px-4 py-3 text-sm font-semibold text-gray-300">Voice</th>
              <th class="text-left px-4 py-3 text-sm font-semibold text-gray-300">Transcript</th>
              <th class="text-left px-4 py-3 text-sm font-semibold text-gray-300">Duration</th>
              <th class="text-left px-4 py-3 text-sm font-semibold text-gray-300">Expires</th>
              <th class="text-center px-4 py-3 text-sm font-semibold text-gray-300">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y" style="border-color: rgba(255,255,255,0.05);">
            <% @shares.each do |share| %>
              <tr class="hover:bg-white/5 transition-colors <%= 'opacity-50' if share.expired? %>">
                <td class="px-4 py-3">
                  <input type="checkbox" form="bulk-form" name="ids[]" value="<%= share.id %>" class="share-checkbox rounded bg-gray-700 border-gray-600">
                </td>
                <td class="px-4 py-3 text-sm text-gray-400 whitespace-nowrap">
                  <%= share.created_at.strftime("%b %d, %Y") %>
                  <span class="text-gray-500 text-xs block"><%= share.created_at.strftime("%l:%M %p") %></span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-400 whitespace-nowrap">
                  <%= voice_name_for(share.voice_preset, @voices) %>
                </td>
                <td class="px-4 py-3 text-sm text-white max-w-xs">
                  <span class="line-clamp-2" title="<%= share.text %>"><%= truncate(share.text, length: 60) %></span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-400 whitespace-nowrap">
                  <%= share.duration ? "#{share.duration.round(1)}s" : "-" %>
                </td>
                <td class="px-4 py-3 text-sm whitespace-nowrap">
                  <% if share.expired? %>
                    <span class="text-red-400">Expired</span>
                  <% else %>
                    <span class="text-green-400"><%= time_ago_in_words(share.expires_at) %></span>
                  <% end %>
                </td>
                <td class="px-4 py-3">
                  <div class="flex items-center justify-center gap-2">
                    <!-- Play Button -->
                    <button type="button" onclick="playAudio('<%= share.token %>')" class="p-2 rounded-md transition-colors hover:bg-white/10" title="Play audio" data-play-btn="<%= share.token %>">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </button>

                    <!-- Delete Button -->
                    <%= link_to admin_tts_share_path(share), data: { turbo_method: :delete, turbo_confirm: "Delete this share?" }, class: "p-2 rounded-md transition-colors hover:bg-white/10", title: "Delete" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-12 px-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
        </svg>
        <h3 class="text-lg font-semibold text-gray-300 mb-2">No TTS shares</h3>
        <p class="text-gray-500">Nothing to moderate yet.</p>
      </div>
    <% end %>
  </div>

  <!-- Hidden audio player -->
  <audio id="global-audio-player" style="display: none;"></audio>
</div>

<script>
// Select all checkbox
document.getElementById('select-all')?.addEventListener('change', function() {
  document.querySelectorAll('.share-checkbox').forEach(cb => cb.checked = this.checked);
});

// Audio player
let currentlyPlayingToken = null;
const audioPlayer = document.getElementById('global-audio-player');

function playAudio(token) {
  const playBtn = document.querySelector(`[data-play-btn="${token}"]`);

  if (currentlyPlayingToken === token && !audioPlayer.paused) {
    audioPlayer.pause();
    resetPlayButton(token);
    currentlyPlayingToken = null;
    return;
  }

  if (currentlyPlayingToken) {
    resetPlayButton(currentlyPlayingToken);
  }

  audioPlayer.src = `/tts/s/${token}/audio`;
  audioPlayer.play();
  currentlyPlayingToken = token;

  if (playBtn) {
    playBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    `;
  }
}

function resetPlayButton(token) {
  const playBtn = document.querySelector(`[data-play-btn="${token}"]`);
  if (playBtn) {
    playBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    `;
  }
}

audioPlayer?.addEventListener('ended', () => {
  if (currentlyPlayingToken) {
    resetPlayButton(currentlyPlayingToken);
    currentlyPlayingToken = null;
  }
});
</script>
