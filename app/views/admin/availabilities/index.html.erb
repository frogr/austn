<style>
  [data-date-cell][data-selected="true"] {
    background: rgba(29, 185, 84, 0.3) !important;
    border-color: rgba(29, 185, 84, 0.6) !important;
    color: #fff !important;
  }
  [data-date-cell][data-past="true"] {
    opacity: 0.35;
    pointer-events: none;
  }
  [data-preset][data-active="true"] {
    background: rgba(29, 185, 84, 0.25) !important;
    border-color: rgba(29, 185, 84, 0.5) !important;
    color: var(--accent-color) !important;
  }
</style>

<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8 max-w-6xl">
  <%# Header %>
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="font-black mb-1" style="font-size: clamp(1.5rem, 3vw, 2rem); color: var(--text-primary); letter-spacing: -0.03em;">
        Availability
      </h1>
      <p class="text-gray-400 text-sm">Click dates, pick a time, and create in bulk</p>
    </div>
    <%= link_to "Add Single", new_admin_availability_path, class: "text-sm px-3 py-1.5 rounded-lg", style: "color: var(--text-secondary); border: 1px solid var(--border-glass);" %>
  </div>

  <% if flash[:notice] %>
    <div class="mb-4 p-3 rounded-lg" style="background: rgba(29, 185, 84, 0.15); border: 1px solid rgba(29, 185, 84, 0.3); color: var(--accent-color); font-size: 0.875rem;">
      <%= flash[:notice] %>
    </div>
  <% end %>
  <% if flash[:alert] %>
    <div class="mb-4 p-3 rounded-lg" style="background: rgba(255, 59, 48, 0.15); border: 1px solid rgba(255, 59, 48, 0.3); color: var(--danger-color); font-size: 0.875rem;">
      <%= flash[:alert] %>
    </div>
  <% end %>

  <%# Calendar + Panel %>
  <div data-controller="availability-calendar" data-availability-calendar-existing-dates-value="<%= @existing_dates.map(&:to_s).to_json %>">
    <div class="flex flex-col lg:flex-row gap-4 mb-8">

      <%# Left: Calendar %>
      <div class="flex-1 p-5 rounded-xl" style="background: var(--bg-glass); border: 1px solid var(--border-glass); backdrop-filter: blur(20px);">
        <%# Month nav %>
        <div class="flex items-center justify-between mb-5">
          <%= link_to admin_availabilities_path(month: (@current_month - 1.month).strftime("%Y-%m")),
                class: "p-2 rounded-lg hover:bg-white/10 transition-colors",
                style: "color: var(--text-secondary);" do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
          <% end %>

          <h2 class="font-semibold" style="font-size: 1.25rem; color: var(--text-primary);">
            <%= @current_month.strftime("%B %Y") %>
          </h2>

          <%= link_to admin_availabilities_path(month: (@current_month + 1.month).strftime("%Y-%m")),
                class: "p-2 rounded-lg hover:bg-white/10 transition-colors",
                style: "color: var(--text-secondary);" do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          <% end %>
        </div>

        <%# Day headers %>
        <div class="grid grid-cols-7 gap-1 mb-2">
          <% %w[Sun Mon Tue Wed Thu Fri Sat].each do |day| %>
            <div class="text-center py-2" style="color: var(--text-muted); font-size: 0.75rem; font-weight: 600;">
              <%= day %>
            </div>
          <% end %>
        </div>

        <%# Calendar grid %>
        <div class="grid grid-cols-7 gap-1">
          <% @current_month.wday.times do %>
            <div class="aspect-square"></div>
          <% end %>

          <% (@current_month..@current_month.end_of_month).each do |date| %>
            <% is_past = date < Date.current %>
            <% has_avail = @existing_dates.include?(date) %>
            <% is_today = date == Date.current %>

            <div data-date-cell
                 data-date="<%= date.to_s %>"
                 data-past="<%= is_past %>"
                 data-selected="false"
                 data-availability-calendar-target="dateCell"
                 data-action="click->availability-calendar#toggleDate"
                 class="aspect-square flex items-center justify-center rounded-lg text-sm font-medium cursor-pointer transition-all relative select-none"
                 style="border: 1px solid <%= is_today ? 'var(--border-glass)' : 'transparent' %>; color: var(--text-secondary);">
              <%= date.day %>
              <% if has_avail %>
                <span class="absolute bottom-1 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full" style="background: var(--accent-color);"></span>
              <% end %>
            </div>
          <% end %>
        </div>

        <%# Selection count + clear %>
        <div class="flex items-center justify-between mt-4 pt-3" style="border-top: 1px solid var(--border-glass);">
          <span class="text-sm" style="color: var(--text-muted);" data-availability-calendar-target="selectionCount">Click dates on the calendar</span>
          <button type="button" data-action="click->availability-calendar#clearSelection" class="text-xs px-2 py-1 rounded" style="color: var(--text-muted); border: 1px solid var(--border-glass);">
            Clear
          </button>
        </div>
      </div>

      <%# Right: Time panel %>
      <div class="lg:w-80 p-5 rounded-xl" style="background: var(--bg-glass); border: 1px solid var(--border-glass); backdrop-filter: blur(20px);">
        <%= form_tag bulk_create_admin_availabilities_path, method: :post do %>
          <input type="hidden" name="dates" value="[]" data-availability-calendar-target="datesInput">

          <h3 class="font-semibold mb-3" style="color: var(--text-primary); font-size: 0.95rem;">Time Preset</h3>
          <div class="grid grid-cols-2 gap-2 mb-4">
            <button type="button" data-preset="morning" data-active="false" data-action="click->availability-calendar#selectPreset"
                    class="px-3 py-2 rounded-lg text-sm transition-all"
                    style="border: 1px solid var(--border-glass); color: var(--text-secondary);">
              Morning<br><span class="text-xs" style="color: var(--text-muted);">9am &ndash; 12pm</span>
            </button>
            <button type="button" data-preset="afternoon" data-active="false" data-action="click->availability-calendar#selectPreset"
                    class="px-3 py-2 rounded-lg text-sm transition-all"
                    style="border: 1px solid var(--border-glass); color: var(--text-secondary);">
              Afternoon<br><span class="text-xs" style="color: var(--text-muted);">1pm &ndash; 5pm</span>
            </button>
            <button type="button" data-preset="fullday" data-active="false" data-action="click->availability-calendar#selectPreset"
                    class="px-3 py-2 rounded-lg text-sm transition-all"
                    style="border: 1px solid var(--border-glass); color: var(--text-secondary);">
              Full Day<br><span class="text-xs" style="color: var(--text-muted);">9am &ndash; 5pm</span>
            </button>
            <button type="button" data-preset="evening" data-active="false" data-action="click->availability-calendar#selectPreset"
                    class="px-3 py-2 rounded-lg text-sm transition-all"
                    style="border: 1px solid var(--border-glass); color: var(--text-secondary);">
              Evening<br><span class="text-xs" style="color: var(--text-muted);">5pm &ndash; 8pm</span>
            </button>
          </div>

          <button type="button" data-preset="custom" data-active="false" data-action="click->availability-calendar#selectPreset"
                  class="w-full px-3 py-2 rounded-lg text-sm mb-4 transition-all"
                  style="border: 1px solid var(--border-glass); color: var(--text-secondary);">
            Custom Time
          </button>

          <input type="hidden" name="start_time" data-availability-calendar-target="startTime">
          <input type="hidden" name="end_time" data-availability-calendar-target="endTime">

          <div class="hidden mb-4" data-availability-calendar-target="customTimeFields">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block text-xs mb-1" style="color: var(--text-muted);">Start</label>
                <input type="time" data-availability-calendar-target="customStart" data-action="change->availability-calendar#syncCustomTime"
                       class="w-full px-3 py-2 rounded-lg text-sm"
                       style="background: var(--bg-secondary); border: 1px solid var(--border-glass); color: var(--text-primary); outline: none;">
              </div>
              <div>
                <label class="block text-xs mb-1" style="color: var(--text-muted);">End</label>
                <input type="time" data-availability-calendar-target="customEnd" data-action="change->availability-calendar#syncCustomTime"
                       class="w-full px-3 py-2 rounded-lg text-sm"
                       style="background: var(--bg-secondary); border: 1px solid var(--border-glass); color: var(--text-primary); outline: none;">
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-xs mb-1" style="color: var(--text-muted);">Slot Duration</label>
            <select name="slot_duration_minutes" class="w-full px-3 py-2 rounded-lg text-sm"
                    style="background: var(--bg-secondary); border: 1px solid var(--border-glass); color: var(--text-primary); outline: none;">
              <option value="15">15 minutes</option>
              <option value="30" selected>30 minutes</option>
              <option value="45">45 minutes</option>
              <option value="60">60 minutes</option>
            </select>
          </div>

          <div class="mb-4">
            <label class="block text-xs mb-1" style="color: var(--text-muted);">Title (optional)</label>
            <input type="text" name="title" placeholder="e.g. Coffee Chat"
                   class="w-full px-3 py-2 rounded-lg text-sm"
                   style="background: var(--bg-secondary); border: 1px solid var(--border-glass); color: var(--text-primary); outline: none;">
          </div>

          <button type="submit" disabled data-availability-calendar-target="submitBtn"
                  class="w-full py-2.5 rounded-lg text-sm font-semibold transition-all"
                  style="background: var(--accent-color); color: #000; opacity: 0.4; cursor: not-allowed;"
                  onmouseenter="if(!this.disabled) this.style.opacity='0.9'"
                  onmouseleave="if(!this.disabled) this.style.opacity='1'">
            Create Availability
          </button>
        <% end %>
      </div>
    </div>
  </div>

  <%# This Month's Availability List %>
  <% if @month_availabilities.any? %>
    <div class="mb-6">
      <h2 class="text-white font-semibold text-sm mb-3"><%= @current_month.strftime("%B %Y") %> Availability</h2>
      <div class="space-y-2">
        <% @availabilities_by_date.each do |date, avails| %>
          <div class="p-4 rounded-lg" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);">
            <p class="text-white font-semibold mb-2"><%= date.strftime("%A, %B %-d") %></p>
            <div class="space-y-1">
              <% avails.each do |avail| %>
                <div class="flex items-center justify-between py-1">
                  <div class="flex items-center gap-3 flex-wrap">
                    <span class="text-sm" style="color: var(--text-secondary);">
                      <%= avail.start_time.strftime("%l:%M %p").strip %> &ndash; <%= avail.end_time.strftime("%l:%M %p").strip %>
                    </span>
                    <span class="text-xs px-2 py-0.5 rounded" style="background: rgba(255,255,255,0.08); color: var(--text-muted);">
                      <%= avail.slot_duration_minutes %>min slots
                    </span>
                    <% if avail.title.present? %>
                      <span class="text-xs" style="color: var(--text-muted);"><%= avail.title %></span>
                    <% end %>
                    <% unless avail.is_active %>
                      <span class="text-xs px-2 py-0.5 rounded" style="background: rgba(255, 149, 0, 0.2); color: var(--warning-color);">Inactive</span>
                    <% end %>
                    <% if avail.has_bookings? %>
                      <span class="text-xs px-2 py-0.5 rounded" style="background: rgba(29, 185, 84, 0.2); color: var(--accent-color);">Has bookings</span>
                    <% end %>
                  </div>
                  <div class="flex items-center gap-2 shrink-0">
                    <%= link_to "Edit", edit_admin_availability_path(avail), class: "text-xs", style: "color: var(--accent-color);" %>
                    <% unless avail.has_bookings? %>
                      <%= button_to "Delete", admin_availability_path(avail), method: :delete,
                            data: { turbo_confirm: "Delete this availability?" },
                            class: "text-xs", style: "color: var(--danger-color); background: none; border: none; cursor: pointer;" %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="mt-6 pt-4 border-t border-gray-800">
    <%= link_to "&larr; Back to Admin".html_safe, admin_root_path, class: "text-gray-500 hover:text-gray-300 text-sm" %>
  </div>
</div>
